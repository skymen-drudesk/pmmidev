<?php

/**
 * @file
 *
 * Main file of module.
 */

use Drupal\page_manager\Entity\Page;
use Drupal\pmmi_page_manager_search\Entity\PageManagerSearch;

/**
 * Implements hook_entity_insert().
 */
function pmmi_page_manager_search_entity_insert(Drupal\Core\Entity\EntityInterface $entity) {
  if ($entity->getEntityTypeId() == 'page_variant') {
    $page = $entity->getPage();

    $render = \Drupal::entityTypeManager()
      ->getViewBuilder('page_variant')
      ->view($entity);

    $content = \Drupal::service('renderer')->renderRoot($render);
    $content = strip_tags($content);
    $content = trim(preg_replace('/\s+/', ' ', $content));

    PageManagerSearch::create([
      'pid' => $entity->id(),
      'title' => $page->label(),
      'content' => $content,
      'path_to_page' => $page->getPath(),
    ])->save();
  }
}

/**
 * Implements hook_entity_update().
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 */
function pmmi_page_manager_search_entity_update(Drupal\Core\Entity\EntityInterface $entity) {
  if ($entity->getEntityTypeId() == 'page_variant') {
    $existing_page_manager_search = \Drupal::entityQuery('pmmi_page_manager_search')
      ->condition('pid', $entity->id())
      ->execute();

    // Load Page of PageVariant.
    $page = $entity->getPage();

    // Get rendered PageVariant content.
    $render = \Drupal::entityTypeManager()
      ->getViewBuilder('page_variant')
      ->view($entity);
    $content = \Drupal::service('renderer')->renderRoot($render);
    $content = strip_tags($content);
    $content = trim(preg_replace('/\s+/', ' ', $content));

    // Check if PageManagerSearch already exists.
    if (empty($existing_page_manager_search)) {
      PageManagerSearch::create([
        'pid' => $entity->id(),
        'title' => $page->label(),
        'content' => $content,
        'path_to_page' => $page->getPath(),
      ])->save();
    }
    else {
      // Load existing PageManagerSearch entity and then update it.
      $existing_page_manager_search_id = reset($existing_page_manager_search);
      $existing_page_manager_search_entity = PageManagerSearch::load($existing_page_manager_search_id);
      $existing_page_manager_search_entity->set('title', $page->label());
      $existing_page_manager_search_entity->set('path_to_page', $page->getPath());
      $existing_page_manager_search_entity->set('content', $content);
      $existing_page_manager_search_entity->save();
    }
  }
}

/**
 * Implements hook_entity_delete().
 */
function pmmi_page_manager_search_entity_delete(Drupal\Core\Entity\EntityInterface $entity) {
  if ($entity->getEntityTypeId() == 'page_variant') {
    $existing_page_manager_search = \Drupal::entityQuery('pmmi_page_manager_search')
      ->condition('pid', $entity->id())
      ->execute();

    if (!empty($existing_page_manager_search)) {
      $existing_page_manager_search_id = reset($existing_page_manager_search);
      $existing_page_manager_search_entity = PageManagerSearch::load($existing_page_manager_search_id);
      $existing_page_manager_search_entity->delete();
    }
  }
}
