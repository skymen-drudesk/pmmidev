<?php

/**
 * @file
 * Includes PMMI Sales Agent Directory extensions.
 */

use Drupal\Component\Utility\Crypt;
use Drupal\Component\Datetime\DateTimePlus;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Site\Settings;

// Define sales agent content ID.
define('PMMI_SALES_AGENT_CONTENT', 'company');
// Define sales agent admin role.
define('PMMI_SALES_AGENT_ADMIN_ROLE', 'sales_agent_admin');
// Define PMMI sales agent mail types.
define('PMMI_SALES_AGENT_MAIL_MASS_REMIND', 'mass_email_remind');
define('PMMI_SALES_AGENT_MAIL_LISTING_NEW', 'mail_listing_new');
define('PMMI_SALES_AGENT_MAIL_LISTING_UPDATE', 'mail_listing_update');

/**
 * Implements hook_theme().
 */
function pmmi_sales_agent_theme() {
  $theme = [];
  $theme['sad_user_stat'] = [
    'render element' => 'elements',
    'file' => 'sad_user_stat.page.inc',
    'template' => 'sad_user_stat',
  ];
  $theme['sad_user_stat_content_add_list'] = [
    'render element' => 'content',
    'variables' => ['content' => NULL],
    'file' => 'sad_user_stat.page.inc',
  ];
  return $theme;
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function pmmi_sales_agent_theme_suggestions_sad_user_stat(array $variables) {
  $suggestions = array();
  $entity = $variables['elements']['#sad_user_stat'];
  $sanitized_view_mode = strtr($variables['elements']['#view_mode'], '.', '_');

  $suggestions[] = 'sad_user_stat__' . $sanitized_view_mode;
  $suggestions[] = 'sad_user_stat__' . $entity->bundle();
  $suggestions[] = 'sad_user_stat__' . $entity->bundle() . '__' . $sanitized_view_mode;
  $suggestions[] = 'sad_user_stat__' . $entity->id();
  $suggestions[] = 'sad_user_stat__' . $entity->id() . '__' . $sanitized_view_mode;
  return $suggestions;
}

/**
 * Implements hook_cron().
 */
function pmmi_sales_agent_cron() {
  // Send mass email remind messages.
  pmmi_sales_agent_remind_send();
  // Notify internal PMMI admin that some companies is pending approval.
  pmmi_sales_agent_internal_admin_remind_send();
}

/**
 * Implements hook_page_attachments().
 */
function pmmi_sales_agent_page_attachments(array &$attachments) {
  $current_path = \Drupal::service('path.current')->getPath();

  // Add simple script to allow auto download of the favorites companies.
  if ($current_path == '/sales-agent-directory/favorites') {
    $script = "window.onload = function() {
      var autoDownload = document.getElementById('auto-download');
      if (autoDownload) { autoDownload.click(); }
    };";

    $attachments['#attached']['html_head'][] = [
      [
        '#tag' => 'script',
        '#value' => $script,
        '#weight' => 10,
      ],
      'pmmi_sales_agent_favourites_auto_download',
    ];
  }
}

/**
 * Implements hook_file_download().
 */
function pmmi_sales_agent_file_download($uri) {
  $scheme = file_uri_scheme($uri);
  $target = file_uri_target($uri);

  // Add some headers to download correct file.
  if ($scheme == 'private' && preg_match("/^\d+-favorites\.csv$/", $target)) {
    return ['Content-disposition' => 'attachment; filename="' . $target . '"'];
  }
}

/**
 * Implements hook_mail().
 */
function pmmi_sales_agent_mail($key, &$message, $params) {
  switch ($key) {
    case 'pmmi_sales_agent_mass':
    case 'mass_email_remind':
    case 'pmmi_sales_agent_listing_agent':
    case 'pmmi_sales_agent_listing_admin':
    case 'pmmi_one_time_update':
      $token_service = \Drupal::token();
      $variables = array('node' => $params['node']);

      // Use default email if it is not specific.
      $from = !empty($params['from']) ? $params['from'] : \Drupal::config('system.site')->get('mail');

      $message['from'] = $from;
      $message['subject'] = $params['subject'];
      $message['body'][] = $token_service->replace($params['body'], $variables);
      break;
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter()
 */
function pmmi_sales_agent_field_widget_moderation_state_default_form_alter(&$element, FormStateInterface $form_state, $context) {
  // Add additional process callback to perform additional manipulation we need.
  $element['#process'][] = 'pmmi_sales_agent_widget_moderation_state_process_actions';
}

/**
 * Implements hook_form_alter().
 */
function pmmi_sales_agent_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  switch ($form_id) {
    case 'node_company_form':
    case 'node_company_edit_form':
      $build_info = $form_state->getBuildInfo();
      $node = $build_info['callback_object']->getEntity();

      // The field descriptions are converted into tooltips (in accordance with
      foreach (['field_main_phone_number', 'field_fax_number'] as $field) {
        if (isset($form[$field])) {
          $form[$field]['widget'][0]['value']['#smart_description'] = FALSE;
        }
      }

      // Add simple flag to make sure that company was changed using node form.
      // It will trigger additional updates, which should be ignored if node was
      // saved in other way.
      $session_key = 'sad_login_' . $node->id();
      $token = \Drupal::request()->get('sad-login-token');
      $node->one_time_update = isset($_SESSION[$session_key], $token) && Crypt::hashEquals($_SESSION[$session_key], $token);
      break;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function pmmi_sales_agent_form_pmmi_company_search_block_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Add extra submit handler to log any usage of the search agent directory.
  $form['#submit'][] = 'pmmi_sales_agent_log_search_stats';
}

/**
 * Extra submit handler to save search statistic.
 *
 * @see pmmi_sales_agent_form_pmmi_company_search_block_form_alter()
 */
function pmmi_sales_agent_log_search_stats(&$form, FormStateInterface $form_state) {
  $values = $form_state->getValues();

  // Create new user stat entity.
  if (!empty($values['country_code'])) {
    \Drupal::entityTypeManager()->getStorage('sad_user_stat')
      ->create([
        'uid' => \Drupal::currentUser()->id(),
        'type' => 'search',
        'field_countries_searched' => $values['country_code'],
      ])->save();
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave() for node entities.
 */
function pmmi_sales_agent_node_presave(EntityInterface $node) {
  if (!empty($node->one_time_update)) {
    // Remove the mails queue for this company.
    \Drupal::service('pmmi_sales_agent.mails_queue')->deletePerCompany($node->id());
    // Update the "Last Update On" field value.
    $new_date = DateTimePlus::createFromTimestamp(time())->format('Y-m-d');
    $node->set('field_last_updated_on', $new_date);
  }
}

/**
 * Process callback to alter action buttons.
 *
 * @see pmmi_sales_agent_field_widget_moderation_state_default_form_alter()
 */
function pmmi_sales_agent_widget_moderation_state_process_actions($element, FormStateInterface $form_state, array &$form) {
  $callback_obj = $form_state->getBuildInfo()['callback_object'] ?: NULL;

  if (!$callback_obj || !($callback_obj instanceof \Drupal\node\NodeForm)) {
    return $element;
  }

  // Override workflow states in accordance with own requirements.
  $node = $callback_obj->getEntity();
  if ($node && ($node->getType() == PMMI_SALES_AGENT_CONTENT)) {
    // In some reason, the node after creation is not flagged as new. Let's add
    // additional flag to make sure that node is new.
    $form['#new'] = $node->isNew() ? TRUE : FALSE;

    // Simple user will see 'Register' operation only (transition to the Draft
    // state). For admin user, we do not need this transition, as admin should
    // be able to publish changes immediately.
    $is_admin = pmmi_sales_agent_is_admin();
    if (!$is_admin) {
      $form['actions']['moderation_state_draft']['#value'] = t('Register');
      $form['actions']['moderation_state_draft']['#submit'][] = 'pmmi_sales_agent_notify_pmmi_admin';
    }
    else {
      $form['actions']['moderation_state_draft']['#access'] = FALSE;
    }

    // If current state is 'Draft', it means that sales agent added new changes.
    // PMMI should review and approve or reject the changes.
    $current_state = $node->get('moderation_state')->getValue()[0]['target_id'] ?: '';
    if (!$form['#new'] && $current_state == 'draft') {
      $form['actions']['moderation_state_published']['#value'] = t('Approve');
      $form['actions']['moderation_state_published']['#submit'][] = 'pmmi_sales_agent_notify_sales_agent';

      // Allow to 'Reject' a listing.
      if ($is_admin) {
        $form['actions']['reject_listing'] = [
          '#type' => 'submit',
          '#value' => t('Reject'),
          '#submit' => [
            'pmmi_sales_agent_reject_listing',
            'pmmi_sales_agent_notify_sales_agent',
          ],
        ];
      }
    }

    foreach ($form['actions'] as $key => &$action) {
      if (strpos($key, 'moderation_state_') === 0) {
        unset($action['#dropbutton']);
      }
    }
  }

  return $element;
}

/**
 * Submit handler to reject a listing.
 */
function pmmi_sales_agent_reject_listing(&$form, FormStateInterface $form_state) {
  $moderation_info = \Drupal::service('content_moderation.moderation_information');
  $node = $form_state->getBuildInfo()['callback_object']->getEntity();

  if ($moderation_info->hasForwardRevision($node)) {
    // Ignore forward unpublished revisions. Revert to default.
    $def_revision_id = $moderation_info->getDefaultRevisionId('node', $node->id());
    $def_revision = node_revision_load($def_revision_id);
    $def_revision->save();
  }
  else {
    // Remove a node immediately.
    $node->delete();
    // Redirect to the homepage, as our company no longer exists.
    $form_state->setRedirect('<front>');
  }
}

/**
 * Notify internal PMMI admin about new changes.
 */
function pmmi_sales_agent_notify_pmmi_admin(&$form, FormStateInterface $form_state) {
  $node = $form_state->getBuildInfo()['callback_object']->getEntity();
  $nid = $node->id();

  $ms = \Drupal::config('pmmi_sales_agent.mail_settings');
  $current_langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();

  // Unset one-time update session token.
  unset($_SESSION['sad_login_' . $nid]);

  // Prepare a message and send it to the internal PMMI admin.
  $params = [
    'subject' => $form['#new'] ? $ms->get('listing_create.subject') : $ms->get('listing_review.subject'),
    'body' => $form['#new'] ? $ms->get('listing_create.body') : $ms->get('listing_review.body'),
    // Field "field_primary_contact_email" is required.
    'from' => $node->get('field_primary_contact_email')->getValue()[0]['value'],
    'node' => $node,
  ];

  $to = $ms->get('mail_notification_address');
  \Drupal::service('plugin.manager.mail')
    ->mail('pmmi_sales_agent', 'pmmi_sales_agent_listing_agent', $to, $current_langcode, $params);

  // Add an email to the queue.
  $type = $form['#new'] ? PMMI_SALES_AGENT_MAIL_LISTING_NEW : PMMI_SALES_AGENT_MAIL_LISTING_UPDATE;
  \Drupal::service('pmmi_sales_agent.mails_queue')
    ->insertPerCompany($nid, $type, REQUEST_TIME + $ms->get('remind_period'));

  // Show an alert to notify that listing should be reviewed.
  if ($message = $ms->get('submission_alert')) {
    drupal_set_message($message);
  }

  // Force to redirect on the node view page.
  $url = \Drupal\Core\Url::fromRoute('entity.node.canonical', ['node' => $nid]);
  $form_state->setRedirectUrl($url);
}

/**
 * Notify sales agent that his changes have been approved.
 */
function pmmi_sales_agent_notify_sales_agent(&$form, FormStateInterface $form_state) {
  $trig_element = $form_state->getTriggeringElement();

  $approve = FALSE;
  if (isset($trig_element['#moderation_state']) && $trig_element['#moderation_state'] == 'published') {
    $approve = TRUE;
  }

  $node = $form_state->getBuildInfo()['callback_object']->getEntity();

  // PMMI has answered, so remove an email from the queue.
  \Drupal::service('pmmi_sales_agent.mails_queue')->deletePerCompany($node->id());

  $ms = \Drupal::config('pmmi_sales_agent.mail_settings');
  $current_langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();

  // Prepare a message and send it to the sales agent.
  $params = [
    'subject' => $approve ? $ms->get('listing_approve.subject') : $ms->get('listing_reject.subject'),
    'body' => $approve ? $ms->get('listing_approve.body') : $ms->get('listing_reject.body'),
    'from' => $ms->get('mail_notification_address'),
    'node' => $node,
  ];

  $to = $node->get('field_primary_contact_email')->getValue()[0]['value'];
  \Drupal::service('plugin.manager.mail')
    ->mail('pmmi_sales_agent', 'pmmi_sales_agent_listing_admin', $to, $current_langcode, $params);
}

/**
 * Sends mass email remind messages.
 */
function pmmi_sales_agent_remind_send() {
  // Select all companies which should receive remind message.
  $nids = \Drupal::service('pmmi_sales_agent.mails_queue')
    ->selectQueueByTypes([PMMI_SALES_AGENT_MAIL_MASS_REMIND]);

  foreach ($nids as $mid => $nid) {
    if ($node = \Drupal\node\Entity\Node::load($nid)) {
      $mail_manager = \Drupal::service('plugin.manager.mail');
      $mail_settings = \Drupal::config('pmmi_sales_agent.mail_settings');

      $params = [
        'subject' => $mail_settings->get('ss_update_reminder.subject'),
        'body' => $mail_settings->get('ss_update_reminder.body'),
        'from' => $mail_settings->get('mail_notification_address'),
        'node' => $node,
      ];

      // Let's send remind message.
      $to = $node->get('field_primary_contact_email')->getValue()[0]['value'];
      $langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();

      $result = $mail_manager->mail('pmmi_sales_agent', 'mass_email_remind', $to, $langcode, $params, TRUE);

      if ($result['result'] === TRUE) {
        // Remove mails queue item as mail has been sent successfully.
        \Drupal::service('pmmi_sales_agent.mails_queue')->delete($mid);
      }
    }
  }
}

/**
 * Sends a remind message to internal PMMI admin.
 */
function pmmi_sales_agent_internal_admin_remind_send() {
  // Select all companies which should should send an email.
  $nids = \Drupal::service('pmmi_sales_agent.mails_queue')
    ->selectQueueByTypes([
      PMMI_SALES_AGENT_MAIL_LISTING_NEW,
      PMMI_SALES_AGENT_MAIL_LISTING_UPDATE,
    ]);

  foreach ($nids as $mid => $nid) {
    if ($node = \Drupal\node\Entity\Node::load($nid)) {
      $mail_manager = \Drupal::service('plugin.manager.mail');
      $mail_settings = \Drupal::config('pmmi_sales_agent.mail_settings');

      $params = [
        'subject' => $mail_settings->get('listing_review.subject'),
        'body' => $mail_settings->get('listing_review.body'),
        'node' => $node,
      ];

      // Let's send remind message.
      $to = $mail_settings->get('mail_notification_address');
      $langcode = \Drupal::languageManager()->getCurrentLanguage()->getId();

      $result = $mail_manager->mail('pmmi_sales_agent', 'pmmi_sales_agent_listing_admin', $to, $langcode, $params, TRUE);

      // Update a record if mail has been sent successfully.
      if ($result['result'] === TRUE) {
        \Drupal::service('pmmi_sales_agent.mails_queue')
          ->updateSendingDate($mid, REQUEST_TIME + $mail_settings->get('remind_period'));
      }
    }
  }
}

/**
 * Implements hook_node_access().
 */
function pmmi_sales_agent_node_access(\Drupal\node\NodeInterface $node, $op, \Drupal\Core\Session\AccountInterface $account) {
  // Allow to update a company by specific one-time update link. Users with the
  // "Bypass content access control" permission ignore this check.
  if ($node->bundle() == PMMI_SALES_AGENT_CONTENT && $op == 'update') {
    if (!$account->hasPermission('pmmi sales agent bypass one time access', $account)) {
      $session_key = 'sad_login_' . $node->id();
      $token = \Drupal::request()->get('sad-login-token');

      // Forbid access to update a node if hash's are not equal.
      if (!isset($_SESSION[$session_key], $token) || !Crypt::hashEquals($_SESSION[$session_key], $token)) {
        return AccessResult::forbidden();
      }
    }
  }
}

/**
 * Checks if current user is internal PMMI admin.
 */
function pmmi_sales_agent_is_admin() {
  $current_user = \Drupal::currentUser();
  return in_array(PMMI_SALES_AGENT_ADMIN_ROLE, $current_user->getRoles()) || $current_user->id() === 1;
}

/**
 * Generates a unique URL for a user to update a listing.
 *
 * @param $nid integer
 *   The node ID.
 *
 * @return string
 *   Unique URL for a user to update a listing.
 */
function pmmi_sales_agent_login_url($nid) {
  $timestamp = REQUEST_TIME;

  return \Drupal::url('pmmi_sales_agent.login', [
    'nid' => $nid,
    'timestamp' => REQUEST_TIME,
    'hash' => pmmi_sales_agent_hash($timestamp, $nid),
  ],
  [
    'absolute' => TRUE,
    'language' =>  \Drupal::languageManager()->getCurrentLanguage()
  ]);
}

/**
 * Creates a unique hash value for use in time-dependent per-node URLs.
 *
 * @param $timestamp integer
 *   The timestamp.
 * @param $nid integer
 *   The node ID.
 *
 * @return string
 *   A base-64 encoded sha-256 hmac.
 */
function pmmi_sales_agent_hash($timestamp, $nid) {
  return Crypt::hmacBase64($timestamp . $nid, Settings::getHashSalt());
}
