#!/usr/bin/env bash

base="$(pwd)";
dd_party_base="/var/www/vendor/summitmedia/dd-party"
DEBUG_MODE=${DEBUG_MODE:-''}
SITE_CODE=${SITE_CODE:-'pmmi'}
SITE_ENVIRONMENT=${SITE_ENVIRONMENT:-'dev'}
WEB_SERVICE=${WEB_SERVICE:-''}
OSX=${OSX:-0}

# Get environment variables.
if [[ -f "$base/.env" ]]; then
  echo "Using Custom ENV file at $base/.env"
  source "$base/.env"
else
  echo "Using Distributed ENV file at $base/env.dist"
  source "$base/env.dist"
fi

# Set defaults
dockercompose="-f docker-compose.yml -f docker-compose.prod.yml"
webcontainer=${SITE_CODE}_prod_web

# Set Docker Compose file based on environment.
if [ "$SITE_ENVIRONMENT" = "test" ]; then
  dockercompose='-f docker-compose.yml -f docker-compose.test.yml'
elif [ "$SITE_ENVIRONMENT" = "dev" ]; then
  dockercompose="-f docker-compose.yml -f docker-compose.override.yml"
fi

if [ "$DEBUG_MODE" = "xdebug" ]; then
  dockercompose+=' -f docker-compose.xdebug.yml'
elif [ "$DEBUG_MODE" = "blackfire" ]; then
  dockercompose+=' -f docker-compose.blackfire.yml'
  if [ "$OSX" = 1 ]; then
    dockercompose+=' -f docker-compose.blackfire.osx.yml'
  fi
fi

if [ "$OSX" = 1 ]; then
  dockercompose+=' -f docker-compose.osx.yml'
fi

echo "Setting up the $SITE_ENVIRONMENT environment using $dockercompose."

echo -e 'Do you wish to proceed (y/n): \c '
read  confirm

if [ "$confirm" != "y" ]; then
  exit 1
fi

echo 'Starting and building Docker containers.'
docker-compose ${dockercompose} up -d --build

if [ "$?" != "0" ]; then
  echo 'Uh oh. The Docker build failed. You should check the output above for errors.'
  exit 1
fi

# Get the container ID of the web service
CONTAINER=$(docker-compose ps -q ${WEB_SERVICE})

echo "Installing dependencies with Composer.";
docker exec -it ${CONTAINER} /bin/bash -c "composer install --optimize-autoloader 2>&1"

if [ "$?" != "0" ]; then
  echo 'Uh oh. Composer install failed. You should check the output above for errors.'
  exit 1
fi

echo 'Initiating Drupal install.'
docker exec -it ${CONTAINER} /bin/bash -c "${dd_party_base}/build/install.sh"
if [ "$?" != "0" ]; then
  echo 'Uh oh. The Drupal install failed. You should check the output above for errors.'
  exit 1
fi

if [ "$?" = "0" ]; then
  echo 'Success! Now get the party started!'
else
  echo 'Uh oh. The party failed to get started. You should check the output above for errors.'
fi
